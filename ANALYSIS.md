# アプリケーション解析メモ

このドキュメントはカレンダーアプリのコード構成と主要な挙動を、日本語で簡潔に整理したものです。

## 技術スタック
- **フレームワーク**: Next.js 16（App Router, TypeScript）
- **フロントエンド**: React 19, Tailwind CSS, FullCalendar, Recharts
- **バックエンド/API**: Next.js API Routes、MySQL（`mysql2`）、Google Cloud Storage
- **認証**: NextAuth.js（Discord OAuth）
- **通知**: Web Push（`web-push`）

## ディレクトリと役割の概要
- `app/page.tsx`: セッション取得後、ログイン済みなら `/calendar` へ即リダイレクト。未ログインは Discord ログインを促すランディング。
- `app/calendar/page.tsx`: FullCalendar を用いたメイン画面。フィルタ・ソート・モバイル判定・応募コメント入力などを含むクライアントコンポーネント。
- `app/api`: 認証・イベント・応募履歴・統計・ギブアウェイ等の API ルート群。
- `lib`: DB 接続、日付ヘルパー、Discord 認証ヘルパー、ロギングなどの共通ユーティリティ。
- `public`: PWA manifest や service worker などの静的アセット。

## 主要な画面挙動（`app/calendar/page.tsx`）
- `/api/events` から取得したデータを配列/オブジェクト両形式に対応して正規化し、ステータスやイベント種別に応じた色を付与。
- フィルタ: 応募済み／未応募、先着、個人、終了イベント表示の切り替え。
- ソート: 日付・人気度・締め切りで並べ替え。
- 表示モード: カレンダー / 今日 / リストの 3 モードを FullCalendar プラグインで提供。
- モバイル判定: 画面幅に応じて挙動や UI を切り替え。
- 応募コメントモーダル: 抽選番号・当落発表日・応募数などを入力し、ユーザー設定の初期値を利用。
- 統計表示: `/api/event-stats` から総応募数・ユニークユーザー数を取得して表示。

## API とデータ連携
- イベント取得: `/api/events`（ステータス・種別に基づく色付けをフロント側で実施）。
- 応募統計: `/api/event-stats`（イベントごとの応募数やユニークユーザー数）。
- ユーザー設定: `/api/user/settings`（応募デフォルト値や複数応募可否を取得）。
- その他: 認証、応募履歴、ギブアウェイ管理など複数の API ルートが `app/api/*` に配置。

## セットアップと運用の手掛かり
- `README.md`: 環境変数設定、依存関係、PM2/Nginx の運用コマンド、Xserver VPS・GCP Storage・ConoHa MySQL などのデプロイ手順を記載。
- `certs/`: 証明書やサービスアカウントなど環境依存の秘密情報を配置し、環境変数経由で参照。
- `tailwind.config.js` / `eslint.config.mjs`: スタイル・静的解析の設定をプロジェクト全体で共有。

## 補足所見
- App Router 構成で UI と API が同居し、サーバレス指向のエンドポイント設計になっている。
- イベントデータの色分けやフィルタはクライアントで完結しており、API は比較的シンプルに保たれている。
- モバイル対応や応募コメントモーダルなど、応募体験を補助する UI ロジックが充実している。
